---
layout: post
title:  Data Analysis | 基于ClickHouse的漏斗模型实践
categories: [data analysis、clickhouse]
description: 基于ClickHouse的漏斗模型实践
keywords: clickhouse、sql
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---

## 背景 <br>
日常工作中做为数仓开发工程师、数据分析师经常碰到漏斗分析模型，本文详细介绍漏斗模型的概念及基本原理，并阐述了其在平台内部的具体实现。针对实际使用过程的问题，探索基于 ClickHouse漏斗模型实践方案。

## 背景需求
```.text
漏斗分析是衡量转化效果、进行转化分析的重要工具，是一种常见的流程式的数据分析方法。
它能够帮助你清晰地了解转化情况，从多角度剖析对比，定位流失原因，提升转化表现。
它主要立足于三大需求场景：
1.定位用户流失具体原因。
2.检测某个专题活动效果。
3.针对不同版本，转化率情况对比。
```

## 概述
- [概念介绍]()
```.text
漏斗模型主要用于分析一个多步骤过程中每一步的转化与流失情况。其中有几个概念要了解：
```
![img](/images/posts/analysis/微信截图_20240326105645.png)<br>
```.text
其中漏斗模型分为两种：无序漏斗和有序漏斗。
定义如下：
无序漏斗：在漏斗的周期内，不限定漏斗多个步骤之间事件发生的顺序。
【计算规则】：假设一个漏斗中包含了 A、B、C 3个步骤，A步骤发生的时间可以在B步骤之前，也可以在B的后面。用户的行为顺序为A、B、C的组合都算成功的漏斗转化。
           即使漏斗步骤之间穿插一些其他事件步骤，依然视作该用户完成一次成功的漏斗转化。
有序漏斗：在漏斗的周期内，严格限定漏斗每个步骤之间的发生顺序。
【计算规则】：假设一个漏斗中包含了 A、B、C 3个步骤，A步骤发生的时间必须在B步骤之前，用户的行为顺序必须为A->B->C 。
           和无序漏斗一样，漏斗步骤之间穿插一些其他事件步骤，依然视作该用户完成一次成功的漏斗转化。
```

##  用漏斗进行的数据分析
```.text
了解了上面的关于漏斗模型的基本概念，我们看一下如何创建一个漏斗。
```
- [选一个漏斗类型]()
```.text
漏斗模型的类型一般分为有序漏斗和无序漏斗，它们的概念已在2.1做了详细的介绍。我们这里以无序漏斗为例，创建漏斗模型。
```
- [添加漏斗步骤]()
```.text
漏斗步骤就是漏斗分析的核心部分，步骤间统计数据的对比，就是我们分析步骤间数据的转化和流失的关键指标。
比如我们以一个“下载应用领红包”的活动为例。预设的用户的行为路径是：用户首先进入【红包首页】，发现最新的红包活动“下载应用，领取红包”，点击进入【红包活动页】，
根据提示跳转到【应用下载页】，选择自己感兴趣的应用下载，完成后，进入【提现页面】领取活动奖励。从上面描述的场景中，我们可以提取出以下关键的四步。
```
![img](/images/posts/analysis/微信截图_20240326110006.png)<br>
- [确定漏斗的时间区间和周期]()
```.text
这里多了一个时间区间的概念，与前文介绍的周期容易混淆。一般来说，此类数据的数仓表是按照时间分区的。所以选择时间区间，本质就是选择要计算的数据范围。
周期是指一个漏斗从第一步流转到最后一步的时间限制，即是用来界定怎样才是一个完整的漏斗。在本例中，我们按照天为周期进行处理，选择时间区间为“2021-05-27”、“2021-05-28”、“2021-05-29”。
```
- [漏斗数据的展示]()
```.text
依据我们设计的漏斗模型（具体模型设计，下文会提及），可以计算出下表的数据：
```
![img](/images/posts/analysis/微信截图_20240326110149.png)<br>
```.text
以表中2021-05-27日的数据为例，触达第一步“红包首页”的用户数量为150,000，在同一天内同时触发第一步“红包首页”和第二步“红包活动页”的人数为11,700。其他数据的含义以此类推。
将表中的数据每步按照日期加起来，就得到2021-05-27至2021-05-29日数据的漏斗图。
从中可以直观的反应出用户在“红包首页”、“红包活动页”、“应用下载页”、“提现页”四步中每一步的人数和转化率。
比如，触达“红包首页”页面的人数为400,000，经过”红包首页“，触达”红包活动页“页面的人数为30,000。则这两个阶段的转化率为：30,000÷400,000=7.5%。
通过对各个阶段人数和转化率的比对，就能比较直观的发现我们这个 “下载应用领红包”的活动用户流失的环节所在，并以此排查原因和优化各个环节。
```
![img](/images/posts/analysis/微信截图_20240326110446.png)<br>

## 整体功能设计及漏斗分析模型的实现
### 功能整体架构设计
![img](/images/posts/analysis/微信截图_20240326110801.png)<br>
```.text
整体工程主要分为配置、计算、存储三阶段。
```
- [1.配置]()
  ```.text
   此阶段主要是工程端的后台服务实现。用户在前端按照自身需求设置漏斗类型、漏斗步骤、筛选条件、时间区间和周期等配置。
   后台服务收到配置请求后，依据漏斗类型选择不同任务组装器进行任务的组装。
   其中，漏斗类型是无序漏斗使用的Hive SQL 任务组装器，而更加复杂的有序漏斗可以使用 Spark任务组装器。组装后生成的任务包含了漏斗模型的计算逻辑，比如 Hive SQL或者 Spark 任务。
  ```
- [2.计算]()
  ```.text
   平台根据接收到的任务的类型，选择Hive或者 Spark引擎进行分析计算。计算结果同步到 MySQL 或者ClickHouse集群。
  ```
- [3.存储]()
  ```.text
   结果集持久化到数据库中，可通过后台服务展示给用户。
  ```
### 无序漏斗实现逻辑
```.text
无序漏斗并不限制其多个步骤之间的发生顺序，只要在限定的周期内完成即可。
在模型的设计上，采用的思想是：在一个周期内，按照步骤顺序依次计算漏斗每一步骤的人数，并且下一层的计算的人群范围要等于上一次计算完成的人群范围，
通过每一步的人群范围可以计算出想要的指标，比如每步的人数（uv）或者访问量（pv）。
```
```.text
如图所示。其中，圈选的人群为每一步的触达的人数，计算的结果集就是基于此人群得到计算结果。步骤1的圈选人群会作为步骤2漏斗计算的一个筛选条件，参与后续计算。
依次类推完成漏斗的每一步计算。最终汇集每一步的计算结果集形成类似于表3.1 的结果数据。
```
![img](/images/posts/analysis/微信截图_20240326111259.png)<br>







## 参考资料





